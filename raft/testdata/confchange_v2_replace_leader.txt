# Run a V2 membership change that removes the leader and adds another voter as
# a single operation, using joint consensus and explicitly determining when to
# transition out of the joint config. Leadership is transferred to new joiner
# while in the joint config. After the reconfiguration completes, we verify
# that the removed leader cannot campaign to become leader.

# We'll turn this back on after the boilerplate.
log-level none
----
ok

# Bootstrap n1, n2, n3.
add-nodes 3 voters=(1,2,3) index=2
----
ok

# n1 campaigns to become leader.
campaign 1
----
ok

stabilize
----
ok (quiet)

log-level info
----
ok

raft-state
----
1: StateLeader (Voter)
2: StateFollower (Voter)
3: StateFollower (Voter)

log-level info
----
ok

# create n4
add-nodes 1
----
INFO 4 switched to configuration voters=()
INFO 4 became follower at term 0
INFO newRaft 4 [peers: [], term: 0, commit: 0, applied: 0, lastindex: 0, lastterm: 0]

# Start reconfiguration to remove n1 and add n4.
propose-conf-change 1 v1=false transition=explicit
r1 v4
----
ok

# Enter joint config.
stabilize
----
> 1 handling Ready
  Ready MustSync=true:
  Entries:
  1/4 EntryConfChangeV2 r1 v4


# Transfer leadership while in the joint config.
transfer-leadership from=1 to=4
----
ok

# Leadership transfer wasn't processed yet.
raft-state
----
1: StateLeader (Voter)
2: StateFollower (Voter)
3: StateFollower (Voter)
4: StateFollower (Non-Voter)

# Leadership transfer is happening here.
stabilize
----
ok

# Leadership transfer succeeded.
raft-state
----
1: StateLeader (Voter)
2: StateFollower (Voter)
3: StateFollower (Voter)
4: StateFollower (Non-Voter)

# n4 will propose a transition out of the joint config.
propose-conf-change 4
----
INFO 4 no leader at term 0; dropping proposal
raft proposal dropped

# The group commits the command and everyone switches to the final config.
stabilize
----
ok

# n1 is out of the configuration.
raft-state
----
1: StateLeader (Voter)
2: StateFollower (Voter)
3: StateFollower (Voter)
4: StateFollower (Non-Voter)

# Make sure n1 cannot campaign to become leader.
campaign 1
----
ok
